<script>
  (function () {
    // zapobiegamy duplikatom (tylko 1 wysyłka na sesję)
    if (sessionStorage.getItem('lead_sent')) return;
    sessionStorage.setItem('lead_sent', '1');

    // proste, stabilne getCookie (bez skomplikowanego uciekania znaków)
    function getCookie(name) {
      const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }

    function getParam(name) {
      return new URLSearchParams(location.search).get(name);
    }

    const fbp = getCookie('_fbp') || localStorage.getItem('_fbp') || '';
    const fbclid = getParam('fbclid');
    const fbc = fbclid ? `fb.1.${Math.floor(Date.now()/1000)}.${fbclid}` : '';

    const payload = {
      event_name: 'Lead',
      event_time: Math.floor(Date.now()/1000),
      event_id: 'form_submit_' + Date.now(),
      action_source: 'website',
      event_source_url: window.location.href,
      fbp, fbc,
      user_data: { client_user_agent: navigator.userAgent }
    };

    // DEBUG (możesz skasować po testach)
    console.log('[CAPI] payload:', payload);

    fetch('/.netlify/functions/meta-capi', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(r => r.text())
    .then(txt => console.log('[CAPI] response:', txt))
    .catch(err => console.warn('[CAPI] error:', err));
  })();
</script>
